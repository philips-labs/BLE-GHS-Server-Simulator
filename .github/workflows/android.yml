name: Build Android

on: push

jobs:
  build:
    name: Build
    runs-on: [self-hosted, research]
    container: philipssoftware/openjdk:8-jdk-alpine

    steps:
      - uses: actions/checkout@v2

      - name: Install ssh
        run: |
          apk add openssh

      - name: clone forest ci repository
        uses: actions/checkout@v2
        with:
          repository: philips-internal/forest-ci
          fetch-depth: 1
          path: .forest
          ref: feature/android-fastlane-action
          ssh-key: ${{ secrets.FOREST_CI_REPO_SSH_KEY }}

      - name: Build debug android application
        uses: ./.forest/actions/mobile/android-fastlane-action
        with:
          mode: build
          target: development
          build_type: Debug
          project: btserver
          version: 0.1
          android_project_dir: .
          project: app

      - name: Sonar Analysis configuration
        uses: philips-software/sonar-scanner-action@v1.2.0
        id: sonarconfig
        with:
          token: ${{ secrets.SONARQUBE_TOKEN }}
          projectName: Conceptworks - bluetoothserver
          projectKey: conceptworks.bluetoothserver
          url: https://sonarqube.ta.philips.com/
          enablePullRequestDecoration: true
          onlyConfig: true

      - name: Sonar Analysis run
        run: |
          ./gradlew --info jacocoTestReport sonarQube ${{ steps.sonarconfig.outputs.sonarParameters }}
